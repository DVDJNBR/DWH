# Story 1.2: Complete and Document SCD Type 2 Historization

**Status**: Draft

**Epic**: B3 Certification Compliance
**Story Statement**:
As a data architect,
I want to complete the implementation and documentation of the SCD Type 2 logic for the `dim_vendor` dimension,
so that data historization fully meets C17 requirements.

**Acceptance Criteria**:
1.  The Stream Analytics query is updated to handle SCD Type 2 changes for vendors.
2.  The `make test-vendors-stream` command successfully validates the new logic.
3.  Documentation for the SCD Type 2 implementation is added to `docs/data_model.md`.
4.  The existing order and clickstream processing is unaffected.

## Dev Notes
*CRITICAL: This section MUST contain ONLY information extracted from architecture documents. NEVER invent or assume technical details.*

### Data Models
*   **Current Star Schema**: `dim_vendor` (SCD Type 2 - In Progress). [Source: brownfield-architecture.md#Current Star Schema]
*   **Schema Location**: Base: `terraform/dwh_schema.sql`. [Source: brownfield-architecture.md#Schema Location]
*   **Technical Debt**: SCD Type 2 Implementation: Currently handled via manual migrations and Stream Analytics updates. Needs a more robust automation for C17. [Source: brownfield-architecture.md#Critical Technical Debt]

### ETL Logic
*   **Stream Analytics**: `terraform/modules/stream_analytics/main.tf` contains the Azure Stream Analytics queries, which will need modification to implement SCD Type 2 logic for `dim_vendor`. [Source: brownfield-architecture.md#ETL Logic]

### Testing Requirements
*   **Vendor Stream Test**: `make test-vendors-stream` (`uv run --directory scripts python tests/test_vendors_stream.py`) will be used to validate the new SCD Type 2 logic. [Source: brownfield-architecture.md#Testing Reality]

## Tasks / Subtasks
*Generate detailed, sequential list of technical tasks based ONLY on: Epic Requirements, Story AC, Reviewed Architecture Information*

- [x] **Analyze existing `terraform/modules/stream_analytics/main.tf`**: Understand current `dim_vendor` processing and identify necessary changes for SCD Type 2.
- [x] **Modify `terraform/modules/stream_analytics/main.tf`**: Update the Stream Analytics query to implement SCD Type 2 logic for the `dim_vendor` dimension (e.g., adding `start_date`, `end_date`, `is_current` columns and logic). (AC: 1)
- [x] **Verify `make deploy`**: Ensure the Terraform deployment of the Stream Analytics job still functions correctly with the updated query.
- [ ] **Generate test data for `dim_vendor`**: Create test cases that simulate vendor updates, including changes that trigger SCD Type 2.
- [ ] **Run `make test-vendors-stream`**: Execute the vendor stream test to validate the implemented SCD Type 2 logic. (AC: 2)
- [ ] **Update `docs/data_model.md`**: Add detailed documentation for the SCD Type 2 implementation on `dim_vendor`, including the schema changes and how the Stream Analytics query handles historization. (AC: 3)
- [ ] **Ensure existing order and clickstream processing is unaffected**: Manually verify that other data flows remain functional after changes. (AC: 4)
- [ ] **Consider rollback strategy**: Document how to revert to the previous state if the SCD Type 2 implementation introduces issues.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
- `terraform/modules/stream_analytics/main.tf` (modified)

## QA Results
*Results from QA Agent QA review of the completed story implementation*
