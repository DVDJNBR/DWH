# Story 1.4: Implement Enhanced Monitoring and Alerting

**Status**: Ready for Review

**Epic**: B3 Certification Compliance
**Story Statement**:
As an operations engineer,
I want a monitoring dashboard and an automated alert system for critical errors,
so that the warehouse's health can be effectively supervised, meeting C16 requirements.

**Acceptance Criteria**:

1.  An Azure Dashboard is created via Terraform, monitoring key metrics (e.g., input/output events, errors).
2.  An Azure Monitor Action Group is configured to send an email for any Stream Analytics job failure.
3.  The dashboard and alerts are documented in a new `docs/monitoring.md` file.

## Dev Notes

_CRITICAL: This section MUST contain ONLY information extracted from architecture documents. NEVER invent or assume technical details._

### Deployment and Operations

- **Existing Logging**: The project already uses Azure Monitor logs. [Source: brownfield-architecture.md#Impact Analysis (B3 Certification Focus)]
- **IaC**: `terraform/main.tf` and `terraform/modules/` will be used to provision new monitoring resources. [Source: brownfield-architecture.md#Infrastructure (IaC)]

## Tasks / Subtasks

_Generate detailed, sequential list of technical tasks based ONLY on: Epic Requirements, Story AC, Reviewed Architecture Information_

- [x] **Design Azure Dashboard**: Define the key metrics to be displayed on the dashboard (e.g., Stream Analytics SU%, input/output events, runtime errors, data conversion errors, late input events).
- [x] **Create Terraform module for Azure Dashboard**: Develop a new Terraform module under `terraform/modules/` to provision the Azure Dashboard. (AC: 1)
- [x] **Create Terraform module for Azure Monitor Action Group**: Develop a new Terraform module to provision the Azure Monitor Action Group with an email receiver. (AC: 2)
- [x] **Integrate new modules into `terraform/main.tf`**: Add the new modules to the main Terraform configuration.
- [x] **Configure Alert Rule**: Create an Azure Monitor alert rule in Terraform that triggers on Stream Analytics job failures and uses the new action group. (AC: 2)
- [x] **Deploy infrastructure changes**: Run `make enable-monitoring` to provision the new monitoring resources.
- [x] **Create `docs/monitoring.md`**: Document the new dashboard, the metrics it displays, and the alert configuration. (AC: 3)
- [x] **Test the alert**: Manually stop the Stream Analytics job to verify that an email alert is received.
- [x] **Verify dashboard functionality**: Check that the new dashboard correctly displays metrics from the running Stream Analytics job.

## Change Log

| Date       | Version | Description                                                                             | Author            |
| :--------- | :------ | :-------------------------------------------------------------------------------------- | :---------------- |
| 2026-01-20 | 1.0     | Initial implementation: Dashboard + Action Group modules (Gemini)                       | Gemini            |
| 2026-01-20 | 1.1     | Fixed corrupted main.tf, added alert rules, completed documentation                     | Claude Opus 4.5   |
| 2026-01-21 | 1.2     | Replaced metric alerts with Activity Log alerts for reliability, added status filtering | James (Dev Agent) |

## Dev Agent Record

_This section is populated by the development agent during implementation_

### Agent Model Used

James (Dev Agent - powered by Gemini 2.5 Pro)

### Debug Log References

- Fixed corrupted `stream_analytics/main.tf` from Gemini's quarantine commit (de224d0)
- Reconstructed file from clean commit (9a37c63) + quarantine features + SCD Type 2 + alert rules

### Completion Notes List

1. **Gemini's work reviewed**: Action Group and Dashboard modules were correctly implemented
2. **Fixed corrupted main.tf**: The file had ~1000 lines of garbage (`.` characters) from Gemini's quarantine commit. Reconstructed properly with all features intact
3. **Added Alert Rules**: Two metric alerts added to `stream_analytics` module:
   - `alert-asa-job-failed`: Triggers when Errors > 0 (Severity 1)
   - `alert-asa-job-stopped`: Triggers when ResourceUtilization < 1% (Severity 0 - Critical)
4. **Added action_group_id variable**: Allows stream_analytics module to receive action group for alerts
5. **Added `make enable-monitoring`**: New Makefile target for deploying monitoring infrastructure
6. **Documentation**: `docs/monitoring.md` updated with alert rules documentation

### File List

- `terraform/modules/action_group/main.tf` - Action Group module (by Gemini)
- `terraform/modules/action_group/variables.tf` - Action Group variables (by Gemini)
- `terraform/modules/action_group/outputs.tf` - Action Group outputs (by Gemini)
- `terraform/modules/dashboard/main.tf` - Dashboard module (by Gemini)
- `terraform/modules/dashboard/variables.tf` - Dashboard variables (by Gemini)
- `terraform/modules/stream_analytics/main.tf` - **MODIFIED**: Added alert rules, fixed corruption
- `terraform/modules/stream_analytics/variables.tf` - **MODIFIED**: Added action_group_id variable
- `terraform/main.tf` - **MODIFIED**: Integrated action_group and dashboard modules (by Gemini)
- `terraform/variables.tf` - **MODIFIED**: Added enable_monitoring and alert_email variables (by Gemini)
- `Makefile` - **MODIFIED**: Added `enable-monitoring` target
- `docs/monitoring.md` - **MODIFIED**: Updated documentation with alert rules

## QA Results

_Results from QA Agent QA review of the completed story implementation_
